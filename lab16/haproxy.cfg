# HAProxy Configuration for MQTT Load Balancing
# --------------------------------------------

global
    log stdout format raw local0

defaults
    log     global
    mode    tcp               # MQTT uses TCP, not HTTP
    option  tcplog
    timeout connect 5s
    timeout client  1m
    timeout server  1m

frontend mqtt_front
    bind *:1883               # Standard MQTT port
    default_backend mqtt_back

backend mqtt_back
    # balance roundrobin: Distribute new connections equally across servers
    balance roundrobin
    
    # Session Stickiness:
    # ------------------
    # Mosquitto doesn't share session state (like subscriptions or offline queues).
    # We use 'stick-table' to ensure a client always returns to the same broker.
    # 'stick on src': Use the client's Source IP as the key for stickiness.
    stick-table type ip size 200k expire 30m
    stick on src
    
    # Backend Servers (The mosquitto cluster)
    server mosquitto1 mosquitto1:1883 check
    server mosquitto2 mosquitto2:1883 check
    server mosquitto3 mosquitto3:1883 check

# Monitoring Dashboard
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /monitor
